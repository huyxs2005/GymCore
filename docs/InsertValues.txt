USE GymCore;
GO

SET ANSI_NULLS ON;
SET ANSI_PADDING ON;
SET ANSI_WARNINGS ON;
SET ARITHABORT ON;
SET CONCAT_NULL_YIELDS_NULL ON;
SET QUOTED_IDENTIFIER ON;
SET NUMERIC_ROUNDABORT OFF;
SET NOCOUNT ON;

BEGIN TRY
    BEGIN TRAN;

    DECLARE @RoleCustomer INT;
    DECLARE @RoleCoach INT;
    DECLARE @RoleReceptionist INT;
    DECLARE @RoleAdmin INT;

    DECLARE @AdminID INT;
    DECLARE @ReceptionistID INT;
    DECLARE @CoachID INT;
    DECLARE @CustomerID INT;

    /* Roles (must-have) */
    INSERT INTO dbo.Roles (RoleName)
    SELECT v.RoleName
    FROM (VALUES
        (N'Customer'),
        (N'Coach'),
        (N'Receptionist'),
        (N'Admin')
    ) AS v(RoleName)
    WHERE NOT EXISTS (
        SELECT 1 FROM dbo.Roles r WHERE r.RoleName = v.RoleName
    );

    SELECT @RoleCustomer = RoleID FROM dbo.Roles WHERE RoleName = N'Customer';
    SELECT @RoleCoach = RoleID FROM dbo.Roles WHERE RoleName = N'Coach';
    SELECT @RoleReceptionist = RoleID FROM dbo.Roles WHERE RoleName = N'Receptionist';
    SELECT @RoleAdmin = RoleID FROM dbo.Roles WHERE RoleName = N'Admin';

    IF @RoleCustomer IS NULL OR @RoleCoach IS NULL OR @RoleReceptionist IS NULL OR @RoleAdmin IS NULL
    BEGIN
        THROW 50001, 'Missing one or more required roles.', 1;
    END;

    /* Users (must-have)
       NOTE: PasswordHash must be bcrypt hashes. Login with plain passwords below:
       - Admin: Admin123456!
       - Receptionist: Reception123456!
       - Coach: Coach123456!
       - Customer: Customer123456!
    */
    INSERT INTO dbo.Users (RoleID, FullName, Email, Phone, PasswordHash, IsEmailVerified, EmailVerifiedAt)
    SELECT v.RoleID, v.FullName, v.Email, v.Phone, v.PasswordHash, v.IsEmailVerified, v.EmailVerifiedAt
    FROM (VALUES
        (@RoleAdmin,        N'Admin GymCore',        N'admin@gymcore.local',      N'0900000001', N'$2a$10$Ms9kKRlpN/13o7CqvZrpMup4lz2MXD1NbKEFZ54qigrtgXlUjzsKO', CAST(1 AS BIT), SYSDATETIME()),
        (@RoleReceptionist, N'Receptionist GymCore', N'reception@gymcore.local',  N'0900000002', N'$2a$10$g/lpvbVBJEUBB4mgSE41d.2Fk.8OnV0Mjoi6zwo1DiLKTV/R/Q/VW', CAST(1 AS BIT), SYSDATETIME()),
        (@RoleCoach,        N'Coach Alex',           N'coach@gymcore.local',      N'0900000003', N'$2a$10$qIOW.bdmO/4t.1OkG1rFBedNhn4hcMVnwesGbTnwTEcIpZMKkJC4G', CAST(1 AS BIT), SYSDATETIME()),
        (@RoleCustomer,     N'Customer Minh',        N'customer@gymcore.local',   N'0900000004', N'$2a$10$EiimMLC5OYOJCTSB.tc0uuOpVpi4IpeFwPqfytKuyd6HohAoerL1m', CAST(1 AS BIT), SYSDATETIME())
    ) AS v(RoleID, FullName, Email, Phone, PasswordHash, IsEmailVerified, EmailVerifiedAt)
    WHERE NOT EXISTS (
        SELECT 1 FROM dbo.Users u WHERE u.Email = v.Email
    );

    SELECT @AdminID = UserID FROM dbo.Users WHERE Email = N'admin@gymcore.local';
    SELECT @ReceptionistID = UserID FROM dbo.Users WHERE Email = N'reception@gymcore.local';
    SELECT @CoachID = UserID FROM dbo.Users WHERE Email = N'coach@gymcore.local';
    SELECT @CustomerID = UserID FROM dbo.Users WHERE Email = N'customer@gymcore.local';

    IF @AdminID IS NULL OR @ReceptionistID IS NULL OR @CoachID IS NULL OR @CustomerID IS NULL
    BEGIN
        THROW 50002, 'Missing one or more required users.', 1;
    END;

    /* Keep seeded accounts verified + valid bcrypt even if re-run */
    UPDATE dbo.Users
    SET IsEmailVerified = 1,
        EmailVerifiedAt = COALESCE(EmailVerifiedAt, SYSDATETIME()),
        PasswordHash = CASE Email
            WHEN N'admin@gymcore.local' THEN N'$2a$10$Ms9kKRlpN/13o7CqvZrpMup4lz2MXD1NbKEFZ54qigrtgXlUjzsKO'
            WHEN N'reception@gymcore.local' THEN N'$2a$10$g/lpvbVBJEUBB4mgSE41d.2Fk.8OnV0Mjoi6zwo1DiLKTV/R/Q/VW'
            WHEN N'coach@gymcore.local' THEN N'$2a$10$qIOW.bdmO/4t.1OkG1rFBedNhn4hcMVnwesGbTnwTEcIpZMKkJC4G'
            WHEN N'customer@gymcore.local' THEN N'$2a$10$EiimMLC5OYOJCTSB.tc0uuOpVpi4IpeFwPqfytKuyd6HohAoerL1m'
            ELSE PasswordHash
        END
    WHERE Email IN (
        N'admin@gymcore.local',
        N'reception@gymcore.local',
        N'coach@gymcore.local',
        N'customer@gymcore.local'
    );

    /* Profiles (must-have) */
    IF NOT EXISTS (SELECT 1 FROM dbo.Coaches WHERE CoachID = @CoachID)
    BEGIN
        INSERT INTO dbo.Coaches (CoachID, DateOfBirth, Gender, ExperienceYears, Bio)
        VALUES (@CoachID, '1998-01-01', N'Male', 5, N'Strength and conditioning coach.');
    END;

    IF NOT EXISTS (SELECT 1 FROM dbo.Customers WHERE CustomerID = @CustomerID)
    BEGIN
        INSERT INTO dbo.Customers (CustomerID, DateOfBirth, Gender)
        VALUES (@CustomerID, '2003-01-01', N'Male');
    END;

    /* Time slots (must-have for booking/check-in flows) */
    INSERT INTO dbo.TimeSlots (SlotIndex, StartTime, EndTime)
    SELECT v.SlotIndex, v.StartTime, v.EndTime
    FROM (VALUES
        (1, CAST('07:00' AS TIME), CAST('08:30' AS TIME)),
        (2, CAST('08:30' AS TIME), CAST('10:00' AS TIME)),
        (3, CAST('10:00' AS TIME), CAST('11:30' AS TIME)),
        (4, CAST('11:30' AS TIME), CAST('13:00' AS TIME)),
        (5, CAST('13:00' AS TIME), CAST('14:30' AS TIME)),
        (6, CAST('14:30' AS TIME), CAST('16:00' AS TIME)),
        (7, CAST('16:00' AS TIME), CAST('17:30' AS TIME)),
        (8, CAST('17:30' AS TIME), CAST('19:00' AS TIME))
    ) AS v(SlotIndex, StartTime, EndTime)
    WHERE NOT EXISTS (
        SELECT 1 FROM dbo.TimeSlots ts WHERE ts.SlotIndex = v.SlotIndex
    );

    /* Membership plans (must-have) */
    INSERT INTO dbo.MembershipPlans (PlanName, PlanType, Price, DurationDays, AllowsCoachBooking, UpdatedBy)
    SELECT v.PlanName, v.PlanType, v.Price, v.DurationDays, v.AllowsCoachBooking, @AdminID
    FROM (VALUES
        (N'Gym Only - 1 Month',     N'GYM_ONLY',       CAST(500000  AS DECIMAL(12,2)),  30, CAST(0 AS BIT)),
        (N'Day Pass',               N'DAY_PASS',       CAST(80000   AS DECIMAL(12,2)),   1, CAST(0 AS BIT)),
        (N'Gym + Coach - 6 Months', N'GYM_PLUS_COACH', CAST(5000000 AS DECIMAL(12,2)), 180, CAST(1 AS BIT))
    ) AS v(PlanName, PlanType, Price, DurationDays, AllowsCoachBooking)
    WHERE NOT EXISTS (
        SELECT 1
        FROM dbo.MembershipPlans mp
        WHERE mp.PlanName = v.PlanName
          AND mp.PlanType = v.PlanType
          AND mp.DurationDays = v.DurationDays
    );

    /* Baseline goals/allergens for AI module setup */
    INSERT INTO dbo.FitnessGoals (GoalCode, GoalName, Description)
    SELECT v.GoalCode, v.GoalName, v.Description
    FROM (VALUES
        (N'LOSE_FAT', N'Lose fat', N'Focus on calorie deficit and cardio/strength mix.'),
        (N'GAIN_MUSCLE', N'Gain muscle', N'Focus on progressive overload and sufficient protein.'),
        (N'MAINTAIN', N'Maintain', N'Maintain current fitness and body composition.')
    ) AS v(GoalCode, GoalName, Description)
    WHERE NOT EXISTS (
        SELECT 1 FROM dbo.FitnessGoals g WHERE g.GoalCode = v.GoalCode
    );

    INSERT INTO dbo.Allergens (AllergenCode, AllergenName, Description, UpdatedBy)
    SELECT v.AllergenCode, v.AllergenName, v.Description, @AdminID
    FROM (VALUES
        (N'MILK', N'Milk', N'Dairy products'),
        (N'EGG', N'Egg', N'Egg and egg products'),
        (N'PEANUT', N'Peanut', N'Peanuts and peanut products')
    ) AS v(AllergenCode, AllergenName, Description)
    WHERE NOT EXISTS (
        SELECT 1 FROM dbo.Allergens a WHERE a.AllergenCode = v.AllergenCode
    );

<<<<<<< HEAD
    /* Products - 20 Sample Gym Supplements */
    INSERT INTO dbo.Products (ProductName, Description, Price, ImageUrl, UpdatedBy)
    SELECT v.ProductName, v.Description, v.Price, v.ImageUrl, @AdminID
    FROM (VALUES
        -- Whey Protein (4 products)
        (N'Whey Protein Isolate - Vanilla', N'100% pure whey protein isolate. 25g protein per serving. Perfect for muscle recovery and growth. Low carb, low fat. Imported from USA.', CAST(1200000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1579722820308-d74e571900a9?w=500'),
        (N'Whey Protein Concentrate - Chocolate', N'Premium whey protein concentrate. 24g protein per serving. Rich chocolate flavor. Great for post-workout. Contains BCAAs and essential amino acids.', CAST(900000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1593095948071-474c5cc2989d?w=500'),
        (N'Whey Protein Blend - Strawberry', N'Advanced whey protein blend (isolate + concentrate). 23g protein per serving. Delicious strawberry taste. Easy to mix, smooth texture.', CAST(950000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1622484211126-f3347e0c2d58?w=500'),
        (N'Hydrolyzed Whey Protein - Unflavored', N'Fast-absorbing hydrolyzed whey protein. 26g protein per serving. Ideal for quick post-workout recovery. Pre-digested for better absorption.', CAST(1350000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1605296867304-46d5465a13f1?w=500'),
        
        -- Creatine (4 products)
        (N'Creatine Monohydrate - Micronized', N'Pure micronized creatine monohydrate. 5g per serving. Supports strength and power output. Clinically proven formula. 100 servings.', CAST(350000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1584464491033-06628f3a6b7b?w=500'),
        (N'Creatine HCL - Ultra Pure', N'Creatine Hydrochloride. Better absorption, no bloating. 3g per serving. Enhanced solubility and bioavailability. 120 servings.', CAST(450000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1534368420702-00fa0cd5a7dc?w=500'),
        (N'Creatine Ethyl Ester', N'Advanced creatine ethyl ester formula. Enhanced cellular uptake. 4g per serving. Supports ATP production and muscle endurance.', CAST(420000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1571902943202-507ec2618e8f?w=500'),
        (N'Buffered Creatine - Kre-Alkalyn', N'pH-buffered creatine for optimal stability. No loading phase required. 3g per serving. Reduced side effects, maximum results.', CAST(500000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1556817411-58c45dd94e8c?w=500'),
        
        -- Mass Gainer (4 products)
        (N'Mass Gainer - Chocolate Supreme', N'High-calorie mass gainer. 1250 calories, 50g protein per serving. Perfect for hard gainers. Contains complex carbs and healthy fats.', CAST(950000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1584464491033-06628f3a6b7b?w=500'),
        (N'Lean Mass Gainer - Vanilla', N'Clean lean mass formula. 800 calories, 45g protein per serving. Low sugar. Premium ingredients for quality muscle gains.', CAST(880000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1593095948071-474c5cc2989d?w=500'),
        (N'Serious Mass - Banana', N'Serious mass building formula. 1300 calories, 52g protein. Enriched with vitamins and minerals. 6 lbs container.', CAST(1000000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1579722820308-d74e571900a9?w=500'),
        (N'Weight Gainer Pro - Cookies & Cream', N'Professional weight gainer. 900 calories, 48g protein per serving. Delicious cookies & cream flavor. Easy to digest.', CAST(850000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1622484211126-f3347e0c2d58?w=500'),
        
        -- Pre-Workout (3 products)
        (N'Pre-Workout Extreme - Fruit Punch', N'High-stimulant pre-workout. 300mg caffeine, beta-alanine, citrulline malate. Explosive energy and pump. Enhanced focus and endurance.', CAST(650000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1605296867304-46d5465a13f1?w=500'),
        (N'Pre-Workout Pump - Blue Raspberry', N'Stimulant-free pump formula. Maximize blood flow and muscle pumps. L-arginine, citrulline, beetroot extract. Great for evening workouts.', CAST(580000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1571902943202-507ec2618e8f?w=500'),
        (N'Pre-Workout Focus - Green Apple', N'Balanced energy and focus. 250mg caffeine, nootropics, electrolytes. Smooth energy without crash. 30 servings.', CAST(600000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1556817411-58c45dd94e8c?w=500'),
        
        -- BCAA (3 products)
        (N'BCAA 2:1:1 - Watermelon', N'Branch Chain Amino Acids 2:1:1 ratio. 5g BCAAs per serving. Supports muscle recovery and reduces fatigue. Refreshing watermelon flavor.', CAST(450000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1534368420702-00fa0cd5a7dc?w=500'),
        (N'BCAA + Electrolytes - Lemon Lime', N'BCAAs with added electrolytes. Perfect for intra-workout hydration. 7g BCAAs, essential minerals. Sugar-free formula.', CAST(520000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1584464491033-06628f3a6b7b?w=500'),
        (N'BCAA Energy - Mixed Berry', N'BCAAs with natural caffeine. 6g BCAAs, 100mg caffeine. Boost energy and recovery during training. Delicious mixed berry taste.', CAST(550000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1593095948071-474c5cc2989d?w=500'),
        
        -- Multivitamin (2 products)
        (N'Multi-Vitamin for Men - Daily Pack', N'Complete multivitamin formula for active men. 24 essential vitamins and minerals. Supports immune system, energy, and muscle function. 30 packs.', CAST(380000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1579722820308-d74e571900a9?w=500'),
        (N'Multi-Vitamin for Athletes - Tablets', N'High-potency multivitamin for athletes. Enhanced B-complex, antioxidants, minerals. Supports recovery and performance. 90 tablets.', CAST(420000 AS DECIMAL(12,2)), N'https://images.unsplash.com/photo-1622484211126-f3347e0c2d58?w=500')
    ) AS v(ProductName, Description, Price, ImageUrl)
    WHERE NOT EXISTS (
        SELECT 1 FROM dbo.Products p WHERE p.ProductName = v.ProductName
    );

    /* Cart */
    IF NOT EXISTS (SELECT 1 FROM dbo.Carts WHERE CustomerID = @CustomerID)
    BEGIN
        INSERT INTO dbo.Carts (CustomerID) VALUES (@CustomerID);
    END;

    SELECT @CartID = CartID FROM dbo.Carts WHERE CustomerID = @CustomerID;
    SELECT @ProdCreatine = ProductID FROM dbo.Products WHERE ProductName = N'Creatine Monohydrate - Micronized';
    SELECT @ProdWhey = ProductID FROM dbo.Products WHERE ProductName = N'Whey Protein Concentrate - Chocolate';

    IF @CartID IS NULL OR @ProdCreatine IS NULL OR @ProdWhey IS NULL
    BEGIN
        THROW 50005, 'Cart or product IDs could not be resolved.', 1;
    END;

    MERGE dbo.CartItems AS tgt
    USING (VALUES
        (@CartID, @ProdCreatine, 1),
        (@CartID, @ProdWhey, 1)
    ) AS src(CartID, ProductID, Quantity)
    ON tgt.CartID = src.CartID AND tgt.ProductID = src.ProductID
    WHEN MATCHED THEN
        UPDATE SET Quantity = src.Quantity
    WHEN NOT MATCHED THEN
        INSERT (CartID, ProductID, Quantity)
        VALUES (src.CartID, src.ProductID, src.Quantity);

    /* Promotion + post + claim */
    IF NOT EXISTS (SELECT 1 FROM dbo.Promotions WHERE PromoCode = N'WELCOME10')
    BEGIN
        INSERT INTO dbo.Promotions (PromoCode, Description, DiscountPercent, DiscountAmount, ValidFrom, ValidTo, IsActive)
        VALUES (
            N'WELCOME10',
            N'10% off for claimed users',
            CAST(10.00 AS DECIMAL(5,2)),
            NULL,
            DATEADD(DAY, -1, SYSDATETIME()),
            DATEADD(DAY, 30, SYSDATETIME()),
            1
        );
    END;

    SELECT @PromoID = PromotionID FROM dbo.Promotions WHERE PromoCode = N'WELCOME10';

    IF @PromoID IS NULL
    BEGIN
        THROW 50006, 'Promotion WELCOME10 was not found.', 1;
    END;

    IF NOT EXISTS (
        SELECT 1
        FROM dbo.PromotionPosts
        WHERE PromotionID = @PromoID
          AND Title = N'Welcome Promo'
    )
    BEGIN
        INSERT INTO dbo.PromotionPosts (Title, Content, BannerUrl, PromotionID, StartAt, EndAt, IsActive, CreatedBy)
        VALUES (
            N'Welcome Promo',
            N'Claim WELCOME10 and use at checkout.',
            NULL,
            @PromoID,
            DATEADD(DAY, -1, SYSDATETIME()),
            DATEADD(DAY, 30, SYSDATETIME()),
            1,
            @AdminID
        );
    END;

    SELECT TOP (1) @PostID = PromotionPostID
    FROM dbo.PromotionPosts
    WHERE PromotionID = @PromoID
      AND Title = N'Welcome Promo'
    ORDER BY PromotionPostID DESC;

    IF @PostID IS NULL
    BEGIN
        THROW 50007, 'Promotion post for WELCOME10 was not found.', 1;
    END;

    IF NOT EXISTS (
        SELECT 1 FROM dbo.UserPromotionClaims
        WHERE UserID = @CustomerID AND PromotionID = @PromoID
    )
    BEGIN
        INSERT INTO dbo.UserPromotionClaims (UserID, PromotionID, SourcePostID)
        VALUES (@CustomerID, @PromoID, @PostID);
    END;

    SELECT @ClaimID = ClaimID
    FROM dbo.UserPromotionClaims
    WHERE UserID = @CustomerID AND PromotionID = @PromoID;

    IF @ClaimID IS NULL
    BEGIN
        THROW 50008, 'Promotion claim was not found for seeded customer.', 1;
    END;

    /* Create or reuse a pending order */
    SELECT TOP (1) @OrderID = OrderID
    FROM dbo.Orders
    WHERE CustomerID = @CustomerID
      AND ClaimID = @ClaimID
      AND Status = 'PENDING'
    ORDER BY OrderID DESC;

    IF @OrderID IS NULL
    BEGIN
        INSERT INTO dbo.Orders (CustomerID, ClaimID, Subtotal, DiscountApplied, TotalAmount, Status)
        VALUES (@CustomerID, @ClaimID, 1250000, 125000, 1125000, 'PENDING');

        SET @OrderID = SCOPE_IDENTITY();
    END;

    MERGE dbo.OrderItems AS tgt
    USING (VALUES
        (@OrderID, @ProdCreatine, 1, CAST(350000 AS DECIMAL(12,2))),
        (@OrderID, @ProdWhey,     1, CAST(900000 AS DECIMAL(12,2)))
    ) AS src(OrderID, ProductID, Quantity, UnitPrice)
    ON tgt.OrderID = src.OrderID AND tgt.ProductID = src.ProductID
    WHEN MATCHED THEN
        UPDATE SET Quantity = src.Quantity, UnitPrice = src.UnitPrice
    WHEN NOT MATCHED THEN
        INSERT (OrderID, ProductID, Quantity, UnitPrice)
        VALUES (src.OrderID, src.ProductID, src.Quantity, src.UnitPrice);

    /* Payment attempt (PENDING) linked to order */
    SET @PayOSLinkId = N'PAYOS_LINK_ORDER_' + CONVERT(NVARCHAR(20), @OrderID);

    IF NOT EXISTS (
        SELECT 1 FROM dbo.Payments
        WHERE OrderID = @OrderID AND Status = 'PENDING'
    )
    BEGIN
        INSERT INTO dbo.Payments (
            OriginalAmount, DiscountAmount, Amount, Status, OrderID,
            PayOS_PaymentLinkId, PayOS_CheckoutUrl, PayOS_Status
        )
        VALUES (
            1125000, 0, 1125000, 'PENDING', @OrderID,
            @PayOSLinkId, N'https://payos.vn/checkout/example', N'PENDING'
        );
    END;

    /* Health: enter height/weight, history trigger updates current */
    IF NOT EXISTS (
        SELECT 1
        FROM dbo.CustomerHealthHistory
        WHERE CustomerID = @CustomerID
          AND HeightCm = CAST(170.00 AS DECIMAL(5,2))
          AND WeightKg = CAST(65.00 AS DECIMAL(5,2))
          AND CAST(RecordedAt AS DATE) = @Start
    )
    BEGIN
        INSERT INTO dbo.CustomerHealthHistory (CustomerID, HeightCm, WeightKg)
        VALUES (@CustomerID, 170.00, 65.00);
    END;

    /* Check-in example (requires ACTIVE membership) */
    IF NOT EXISTS (
        SELECT 1
        FROM dbo.CheckIns
        WHERE CustomerID = @CustomerID
          AND CustomerMembershipID = @CustomerMembershipID
          AND CAST(CheckInTime AS DATE) = @Start
    )
    BEGIN
        INSERT INTO dbo.CheckIns (CustomerID, CustomerMembershipID, CheckedByUserID)
        VALUES (@CustomerID, @CustomerMembershipID, @ReceptionistID);
    END;

    /* Coach availability (Mon/Wed/Fri slot 1 and 2) */
    SELECT @Slot1 = TimeSlotID FROM dbo.TimeSlots WHERE SlotIndex = 1;
    SELECT @Slot2 = TimeSlotID FROM dbo.TimeSlots WHERE SlotIndex = 2;

    IF @Slot1 IS NULL OR @Slot2 IS NULL
    BEGIN
        THROW 50009, 'Required timeslots were not found.', 1;
    END;

    INSERT INTO dbo.CoachWeeklyAvailability (CoachID, DayOfWeek, TimeSlotID, IsAvailable)
    SELECT v.CoachID, v.DayOfWeek, v.TimeSlotID, v.IsAvailable
    FROM (VALUES
        (@CoachID, 1, @Slot1, CAST(1 AS BIT)),
        (@CoachID, 3, @Slot1, CAST(1 AS BIT)),
        (@CoachID, 5, @Slot1, CAST(1 AS BIT)),
        (@CoachID, 1, @Slot2, CAST(1 AS BIT)),
        (@CoachID, 3, @Slot2, CAST(1 AS BIT)),
        (@CoachID, 5, @Slot2, CAST(1 AS BIT))
    ) AS v(CoachID, DayOfWeek, TimeSlotID, IsAvailable)
    WHERE NOT EXISTS (
        SELECT 1
        FROM dbo.CoachWeeklyAvailability cwa
        WHERE cwa.CoachID = v.CoachID
          AND cwa.DayOfWeek = v.DayOfWeek
          AND cwa.TimeSlotID = v.TimeSlotID
    );

    /* PT Request + sessions */
    SELECT TOP (1) @PTRequestID = PTRequestID
    FROM dbo.PTRecurringRequests
    WHERE CustomerID = @CustomerID
      AND Status = 'APPROVED'
    ORDER BY PTRequestID DESC;

    IF @PTRequestID IS NULL
    BEGIN
        INSERT INTO dbo.PTRecurringRequests (
            CustomerID, CoachID, CustomerMembershipID, StartDate, EndDate, Status
        )
        VALUES (
            @CustomerID, @CoachID, @CustomerMembershipID, @Start, DATEADD(DAY, 28, @Start), 'APPROVED'
        );

        SET @PTRequestID = SCOPE_IDENTITY();
    END;

    SELECT @PTBaseStart = StartDate
    FROM dbo.PTRecurringRequests
    WHERE PTRequestID = @PTRequestID;

    IF @PTBaseStart IS NULL
    BEGIN
        SET @PTBaseStart = @Start;
    END;

    INSERT INTO dbo.PTRequestSlots (PTRequestID, DayOfWeek, TimeSlotID)
    SELECT v.PTRequestID, v.DayOfWeek, v.TimeSlotID
    FROM (VALUES
        (@PTRequestID, 1, @Slot1),
        (@PTRequestID, 3, @Slot1),
        (@PTRequestID, 5, @Slot1)
    ) AS v(PTRequestID, DayOfWeek, TimeSlotID)
    WHERE NOT EXISTS (
        SELECT 1
        FROM dbo.PTRequestSlots prs
        WHERE prs.PTRequestID = v.PTRequestID
          AND prs.DayOfWeek = v.DayOfWeek
          AND prs.TimeSlotID = v.TimeSlotID
    );

    INSERT INTO dbo.PTSessions (PTRequestID, CustomerID, CoachID, SessionDate, DayOfWeek, TimeSlotID, Status)
    SELECT v.PTRequestID, v.CustomerID, v.CoachID, v.SessionDate, v.DayOfWeek, v.TimeSlotID, v.Status
    FROM (VALUES
        (@PTRequestID, @CustomerID, @CoachID, DATEADD(DAY, 1, @PTBaseStart), 1, @Slot1, N'SCHEDULED'),
        (@PTRequestID, @CustomerID, @CoachID, DATEADD(DAY, 3, @PTBaseStart), 3, @Slot1, N'SCHEDULED'),
        (@PTRequestID, @CustomerID, @CoachID, DATEADD(DAY, 5, @PTBaseStart), 5, @Slot1, N'SCHEDULED')
    ) AS v(PTRequestID, CustomerID, CoachID, SessionDate, DayOfWeek, TimeSlotID, Status)
    WHERE NOT EXISTS (
        SELECT 1
        FROM dbo.PTSessions s
        WHERE s.PTRequestID = v.PTRequestID
          AND s.SessionDate = v.SessionDate
          AND s.TimeSlotID = v.TimeSlotID
    );

=======
>>>>>>> a8c52545b2b30ebdd29d3b510d6e83bcc3c5c5a7
    COMMIT TRAN;
END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK TRAN;
    THROW;
END CATCH;

/*
Run order:
1) docs/GymCore.txt
2) docs/InsertValues.txt            -- required baseline data
3) docs/InsertTestingValues.txt     -- optional example/testing data
*/
